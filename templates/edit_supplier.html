{% extends "base.html" %}

{% block title %}تعديل المورد - برنامج إدارة مخزون محل الهواتف{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2 mb-0">
            <i class="fas fa-truck me-2"></i>
            تعديل المورد: {{ supplier.name }}
        </h1>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('suppliers') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-right me-2"></i>
            العودة للموردين
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-building me-2"></i>
                    تعديل بيانات المورد
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="supplierForm">
                    {{ form.csrf_token }}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.name.label(class="form-label") }}
                            {{ form.name(class="form-control", value=supplier.name, placeholder="الاسم الكامل للمورد") }}
                            {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.name.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form.company.label(class="form-label") }}
                            {{ form.company(class="form-control", value=supplier.company or '', placeholder="اسم الشركة أو المؤسسة") }}
                            {% if form.company.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.company.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form.phone.label(class="form-label") }}
                            {{ form.phone(class="form-control", value=supplier.phone or '', placeholder="01xxxxxxxxx") }}
                            {% if form.phone.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.phone.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            {{ form.email.label(class="form-label") }}
                            {{ form.email(class="form-control", value=supplier.email or '', placeholder="example@company.com") }}
                            {% if form.email.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.email.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="col-md-12 mb-3">
                            {{ form.address.label(class="form-label") }}
                            {{ form.address(class="form-control", rows="3", value=supplier.address or '', placeholder="العنوان الكامل للمورد أو الشركة...") }}
                            {% if form.address.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.address.errors %}
                                <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-save me-2"></i>
                                حفظ التعديلات
                            </button>
                            <a href="{{ url_for('suppliers') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>
                                إلغاء
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- معاينة المورد -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-eye me-2"></i>
                    معاينة المورد
                </h5>
            </div>
            <div class="card-body">
                <div id="supplierPreview">
                    <!-- سيتم ملؤها بـ JavaScript -->
                </div>
            </div>
        </div>

        <!-- معلومات إضافية -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    معلومات المورد
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <strong>تاريخ التسجيل:</strong><br>
                        <small class="text-muted">{{ supplier.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                    </li>
                    <li class="mb-0">
                        <strong>عدد المنتجات:</strong><br>
                        <small class="text-muted">{{ supplier.products|length }} منتج</small>
                    </li>
                </ul>
            </div>
        </div>

        <!-- المنتجات المرتبطة -->
        {% if supplier.products %}
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-mobile-alt me-2"></i>
                    المنتجات المرتبطة
                </h6>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for product in supplier.products[:5] %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ product.name }}</strong><br>
                            <small class="text-muted">{{ product.brand }}</small>
                        </div>
                        <span class="badge bg-primary">{{ product.quantity }}</span>
                    </div>
                    {% endfor %}
                    {% if supplier.products|length > 5 %}
                    <div class="list-group-item text-center">
                        <small class="text-muted">و {{ supplier.products|length - 5 }} منتج آخر...</small>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // معاينة المورد في الوقت الفعلي
    function updatePreview() {
        const name = document.getElementById('name').value || 'اسم المورد';
        const company = document.getElementById('company').value;
        const phone = document.getElementById('phone').value;
        const email = document.getElementById('email').value;
        const address = document.getElementById('address').value;

        const previewHtml = `
            <div class="text-center">
                <div class="bg-light p-3 rounded mb-3">
                    <i class="fas fa-truck fa-2x text-primary mb-2"></i>
                    <h6 class="fw-bold">${name}</h6>
                    ${company ? `<p class="text-muted mb-0">${company}</p>` : ''}
                </div>
                
                <div class="text-start">
                    ${phone ? `
                    <div class="mb-2">
                        <i class="fas fa-phone text-success me-2"></i>
                        <small>${phone}</small>
                    </div>
                    ` : ''}
                    
                    ${email ? `
                    <div class="mb-2">
                        <i class="fas fa-envelope text-info me-2"></i>
                        <small>${email}</small>
                    </div>
                    ` : ''}
                    
                    ${address ? `
                    <div class="mb-2">
                        <i class="fas fa-map-marker-alt text-warning me-2"></i>
                        <small>${address.substring(0, 50)}${address.length > 50 ? '...' : ''}</small>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;

        document.getElementById('supplierPreview').innerHTML = previewHtml;
    }

    // ربط الأحداث
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = ['name', 'company', 'phone', 'email', 'address'];
        inputs.forEach(inputId => {
            const element = document.getElementById(inputId);
            if (element) {
                element.addEventListener('input', updatePreview);
            }
        });

        updatePreview();
    });

    // تنسيق رقم الهاتف
    document.getElementById('phone').addEventListener('input', function () {
        let value = this.value.replace(/\D/g, ''); // إزالة كل شيء عدا الأرقام

        // التحقق من أن الرقم يبدأ بـ 01
        if (value.length > 0 && !value.startsWith('01')) {
            if (value.startsWith('1')) {
                value = '0' + value;
            }
        }

        // تحديد الطول الأقصى
        if (value.length > 11) {
            value = value.substring(0, 11);
        }

        this.value = value;
        updatePreview();
    });

    // التحقق من صحة البريد الإلكتروني
    document.getElementById('email').addEventListener('blur', function () {
        const email = this.value;
        if (email && !isValidEmail(email)) {
            this.setCustomValidity('يرجى إدخال بريد إلكتروني صحيح');
        } else {
            this.setCustomValidity('');
        }
    });

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    // التحقق من صحة النموذج
    document.getElementById('supplierForm').addEventListener('submit', function (e) {
        const name = document.getElementById('name').value.trim();

        if (!name) {
            e.preventDefault();
            alert('يرجى إدخال اسم المورد');
            document.getElementById('name').focus();
            return false;
        }

        const email = document.getElementById('email').value;
        if (email && !isValidEmail(email)) {
            e.preventDefault();
            alert('يرجى إدخال بريد إلكتروني صحيح');
            document.getElementById('email').focus();
            return false;
        }

        return true;
    });
</script>
{% endblock %}