{% extends "base.html" %}

{% block title %}فاتورة شراء رقم {{ purchase.invoice_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">فاتورة شراء رقم: {{ purchase.invoice_number }}</h3>
                    <div>
                        <div class="btn-group me-2" role="group">
                            <a href="{{ url_for('purchase_regular_pdf', purchase_id=purchase.id) }}"
                                class="btn btn-success" target="_blank" title="PDF عادي (A4)">
                                <i class="fas fa-file-pdf me-1"></i>
                                عادي
                            </a>
                            <button type="button" class="btn btn-dark" title="طباعة حرارية 80mm"
                                onclick="printThermalPurchase()">
                                <i class="fas fa-receipt me-1"></i>
                                حراري 80mm
                            </button>
                        </div>
                        <a href="{{ url_for('purchases') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> العودة
                        </a>
                    </div>
                </div>

                <div class="card-body">
                    <!-- معلومات الفاتورة -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h5>معلومات الفاتورة</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>رقم الفاتورة:</strong></td>
                                    <td>{{ purchase.invoice_number }}</td>
                                </tr>
                                <tr>
                                    <td><strong>التاريخ:</strong></td>
                                    <td>{{ purchase.created_at.strftime('%Y-%m-%d %H:%M')|english_numbers }}</td>
                                </tr>
                                <tr>
                                    <td><strong>طريقة الدفع:</strong></td>
                                    <td><span class="badge bg-info">{{ purchase.payment_method }}</span></td>
                                </tr>
                            </table>
                        </div>

                        <div class="col-md-6">
                            <h5>معلومات المورد</h5>
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>الاسم:</strong></td>
                                    <td>{{ purchase.supplier.name }}</td>
                                </tr>
                                {% if purchase.supplier.company %}
                                <tr>
                                    <td><strong>الشركة:</strong></td>
                                    <td>{{ purchase.supplier.company }}</td>
                                </tr>
                                {% endif %}
                                {% if purchase.supplier.phone %}
                                <tr>
                                    <td><strong>الهاتف:</strong></td>
                                    <td>{{ purchase.supplier.phone|english_numbers }}</td>
                                </tr>
                                {% endif %}
                                {% if purchase.supplier.email %}
                                <tr>
                                    <td><strong>البريد:</strong></td>
                                    <td>{{ purchase.supplier.email }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                    </div>

                    <!-- عناصر الفاتورة -->
                    <h5>عناصر الفاتورة</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead class="table-dark">
                                <tr>
                                    <th>المنتج</th>
                                    <th>الماركة</th>
                                    <th>الموديل</th>
                                    <th>الكمية</th>
                                    <th>سعر الوحدة</th>
                                    <th>المجموع</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in purchase.purchase_items %}
                                <tr>
                                    <td>{{ item.product.name }}</td>
                                    <td>{{ item.product.brand }}</td>
                                    <td>{{ item.product.model }}</td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end">{{ item.unit_price|currency }}</td>
                                    <td class="text-end"><strong>{{ item.total_price|currency }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- المجاميع -->
                    <div class="row">
                        <div class="col-md-8"></div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <table class="table table-borderless">
                                        <tr>
                                            <td><strong>المجموع الفرعي:</strong></td>
                                            <td class="text-end">{{ purchase.total_amount|currency }}</td>
                                        </tr>
                                        {% if purchase.discount > 0 %}
                                        <tr>
                                            <td><strong>الخصم:</strong></td>
                                            <td class="text-end text-danger">- {{ purchase.discount|currency }}</td>
                                        </tr>
                                        {% endif %}
                                        <tr class="table-success">
                                            <td><strong>المجموع النهائي:</strong></td>
                                            <td class="text-end"><strong>{{ purchase.final_amount|currency }}</strong>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ملاحظات -->
                    {% if purchase.notes %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-sticky-note"></i> ملاحظات:</h6>
                                <p class="mb-0">{{ purchase.notes }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- إيصال حراري 80mm للطباعة المباشرة (فاتورة شراء) -->
<div id="thermal-receipt-purchase" class="mt-3">
    <div class="thermal-container">
        <div class="text-center mb-2">
            <div class="fw-bold" style="font-size:14px">MOBILE PHONE STORE</div>
            <div style="font-size:12px">متجر الهواتف</div>
            <div style="font-size:10px">Algiers, Algeria</div>
            <div style="font-size:10px">Tel: +213 123 456 789</div>
        </div>

        <div class="d-flex justify-content-between" style="font-size:11px">
            <div>Receipt: {{ purchase.invoice_number|english_numbers }}</div>
            <div>{{ purchase.created_at.strftime('%Y-%m-%d %H:%M')|english_numbers }}</div>
        </div>

        <div class="mt-1" style="font-size:11px">
            المورد: {{ purchase.supplier.name }}{% if purchase.supplier.phone %} - {{
            purchase.supplier.phone|english_numbers }}{% endif %}
        </div>

        <hr class="my-1" />

        <div class="items" style="font-size:11px">
            <div class="d-flex fw-bold">
                <div style="width:48%">المنتج</div>
                <div style="width:12%" class="text-center">الكمية</div>
                <div style="width:20%" class="text-end">سعر الوحدة</div>
                <div style="width:20%" class="text-end">المجموع</div>
            </div>
            <div style="border-top:1px solid #000; margin:2px 0"></div>
            {% for item in purchase.purchase_items %}
            <div class="d-flex">
                <div style="width:48%">{{ item.product.name }}</div>
                <div style="width:12%" class="text-center">{{ item.quantity }}</div>
                <div style="width:20%" class="text-end">{{ item.unit_price|currency }}</div>
                <div style="width:20%" class="text-end">{{ item.total_price|currency }}</div>
            </div>
            {% endfor %}
        </div>

        <div style="border-top:1px dashed #000; margin:4px 0"></div>

        <div class="totals" style="font-size:12px">
            <div class="d-flex justify-content-between">
                <div>المجموع الفرعي</div>
                <div>{{ purchase.total_amount|currency }}</div>
            </div>
            {% if purchase.discount > 0 %}
            <div class="d-flex justify-content-between">
                <div>الخصم</div>
                <div>- {{ purchase.discount|currency }}</div>
            </div>
            {% endif %}
            <div class="d-flex justify-content-between fw-bold" style="font-size:13px">
                <div>المجموع النهائي</div>
                <div>{{ purchase.final_amount|currency }}</div>
            </div>
            <div class="text-center mt-1" style="font-size:11px">طريقة الدفع: {{ purchase.payment_method }}</div>
        </div>

        {% if purchase.notes %}
        <div class="mt-1" style="font-size:10px">ملاحظات: {{ purchase.notes }}</div>
        {% endif %}

        <div class="text-center mt-2" style="font-size:11px">
            شكراً لتعاملكم معنا
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    @media print {

        /* وضع الطباعة الحرارية لشراء */
        body.purchase-thermal-print nav,
        body.purchase-thermal-print .btn,
        body.purchase-thermal-print .main-content .row:first-child,
        body.purchase-thermal-print .card {
            display: none !important;
        }

        body.purchase-thermal-print #thermal-receipt-purchase {
            display: block !important;
        }

        @page {
            size: 80mm auto;
            margin: 4mm 3mm;
        }

        body {
            background: white !important;
        }
    }

    #thermal-receipt-purchase {
        display: none;
    }

    .thermal-container {
        width: 80mm;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function printThermalPurchase() {
        document.body.classList.add('purchase-thermal-print');
        setTimeout(function () {
            window.print();
        }, 50);
        window.onafterprint = function () {
            document.body.classList.remove('purchase-thermal-print');
        };
    }
</script>
{% endblock %}